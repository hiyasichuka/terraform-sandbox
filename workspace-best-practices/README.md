# Terraform ワークスペースとプロジェクトのベストプラクティス

## 設定構造

### 重複する設定を避ける

技術的負債の一般的な原因の一つは、Terraform設定が散らばること。
チームは、類似のリソースをプロビジョニングするために設定を重複させることがよくある。
設定を変更する必要がある場合、一箇所ではなく多くの場所で変更を加える必要がある。

Terraformはmoduleをサポートしており、一緒にデプロイできるリソースの再利用可能なコレクションを定義できる。
設定をモジュールにカプセル化することで、一度だけ更新でOK
組織のメンバーは、組織のプライベートモジュールレジストリからモジュールを参照できる。
また、モジュールをバージョン管理することで安定性を高めることができる。
開発者がモジュールの特定のバージョンに設定を固定すると、そのモジュールが毎回同じインフラストラクチャを構築できる。

## リポジトリの範囲を決定する

バージョン管理リポジトリに接続されたワークスペースを作成する際、作業ディレクトリを設定する。
作業ディレクトリはリポジトリのルートがデフォルトですが、同じリポジトリ内で複数の環境やリソースのコレクションを管理する場合は、代わりにサブディレクトリを選択できる。
これにより、ワークスペースごとに1つのリポジトリを作成するか、複数のワークスペースの設定を1つのリポジトリにまとめるかを選択できます。
どちらのアプローチも有効なので、組織にとって最適なアプローチを選択する。

## モジュールの便利さと柔軟性を評価する

モジュールを使用することで、Terraform設定の重複を減らすことができる。
ただモジュールのスコープを決めることは便利さと柔軟性のトレードオフ。
コードの重複を減らすために、設定入力変数によって再利用可能に設計されたモジュールを設計できる。
しかし、モジュールをより小さなスコープで設計することで、チームは新しいモジュールバージョン内の新機能を他の機能やリソースに影響を与えることなく扱える。＝柔軟性が上がる。

## 子モジュールを制限する

モジュールのネスㇳは、設定の依存関係グラフを複雑にし、追跡する必要がある参照の数を大幅に増加させる。
ネストされたモジュールの影響はモジュール自体に依存しますが、最大2つの深さに制限することをお勧め。
つまり、1つのモジュールが別のモジュールを呼び出す。

# ワークスペース構造

Terraform Cloudワークスペースは、単一の状態ファイルとそのリソースのライフサイクルを管理します。
これは、Terraform Cloudで管理されるインフラストラクチャの最小のコレクションです。
リソースに対する操作は、同じ状態ファイルで管理される他のリソースに影響を与える可能性があるため、操作の潜在的な影響範囲を小さく保つことが最善です。
そのためには、可能な限りリソースを別々のワークスペースで管理し、必要で論理的に関連するリソースのみをまとめます。たとえば、アプリケーションがコンピュートリソースとデータベースの両方を必要とする場合でも、これらのリソースは独立して動作できるため、それぞれ独自のワークスペースにあるべきです。
Terraform CloudおよびTerraform Enterpriseの採用を早い段階で設定とワークスペース戦略を計画することで、操作を簡素化し、より安全にすることができます。

## 変動性によってグループ化する

変動性は、ワークスペース内のリソースが変更される頻度を指します。データベース、VPC、サブネットなどのインフラは、ウェブサーバーなどのインフラに比べてはるかに頻繁に変更されません。
長期間存続するインフラストラクチャを不必要な変動性にさらすことで、偶発的な変更の機会が増えます。
ワークスペースの組織を計画する際には、変動性によってリソースをグループ化します。